# Лабораторная работа 3

**Название:** "Разработка драйверов сетевых устройств"

**Цель работы:** получить знания и навыки разработки драйверов сетевых интерфейсов для операционной системы Linux.


## Описание функциональности драйвера

1. Драйвер создает виртуальный сетевой интерфейс, заданный исполнителем (по умолчанию *vni0*).
2. Драйвер позволяет перехватывать сетевой трафик родительского интерфейса, заданного исполнителем (по умолчанию  *enp0s3*).
3. Драйвер позволяет фильтровать трафик и вычлинять UDP пакеты адресуемые на порт, заданный исполнителем (по умолчанию 15). 
4. Драйвер логирует порты отправителя и получателя отфильтрованного пакета.
5. Драйвер позволяет просмотреть статистику работы созданного интерфейса. 

## Инструкция по сборке

1. Для сборки установочных файлов драйвера необходимо выполнить команду 
   из директории `/lab3`
```
# make Makefile
```
2. Для установки драйвера после сборки необходимо выполнить команду
```
# sudo insmod virt_net_if.ko
```
3. Для удаления драйвера и самого блочного устройства необходимо выполнить команду
```
# sudo rmmod virt_net_if
```
4. Для удаления всех установочных файлов необходимо выполнить команду
```
# make Makefile clean
```

## Инструкция пользователя

Для вывода последовательности полученных пакетов в консоль пользователя необходимо выполнить команду чтения из файла `/proc/vni0` с помощью утилит для чтения текста из файла. 

1. Утилита **cat**
```
# cat /proc/vni0
```
2. Утилита **head**
```
# head [-n count] /proc/vni0
```
*Выводит **count-4** первых пакетов при использовании опции **-n**.*

*Выводит **6** первых пакетов без использования опции **-n**.*

3. Утилита **tail**
```
# tail [-n count] /proc/vni0
```
*Только для вывода в консоль пользователя:*

*Выводит **count** последних результатов при использовании опции **-n**.*

*Выводит **10** последних результатов без использования опции **-n**.*

---

## Примеры использования

**Установка драйвера**
```
root# sudo insmod virt_net_if.ko
root# dmesg 
[ 1561.458083] virt_net_if: proc file is created
[ 1561.462815] Module virt_net_if loaded
[ 1561.462816] virt_net_if: create link vni0
[ 1561.462818] virt_net_if: registered rx handler for enp0s3
[ 1561.503533] IPv6: ADDRCONF(NETDEV_UP): vni0: link is not ready
```
**Просмотр перехваченного трафика**
```
root# cat /proc/vni0
-----------
UDP ports
-----------
src	dst
50403	15
50403	15
50403	15
50403	15

root# dmesg 
[   92.027095] vni0: device opened
[  218.971410] Captured UDP datagram, IPsrc: 192.168.43.100 PORTsrc: 50403
[  218.971431] IPdst: 192.168.43.238 PORTdst: 15
[  219.419621] Captured UDP datagram, IPsrc: 192.168.43.100 PORTsrc: 50403
[  219.419642] IPdst: 192.168.43.238 PORTdst: 15
[  219.772980] Captured UDP datagram, IPsrc: 192.168.43.100 PORTsrc: 50403
[  219.772997] IPdst: 192.168.43.238 PORTdst: 15
[  220.557978] Captured UDP datagram, IPsrc: 192.168.43.100 PORTsrc: 50403
[  220.558001] IPdst: 192.168.43.238 PORTdst: 15
[  235.977290] proc file: read()
```
**Удаление драйвера**
```
root# sudo rmmod virt_net_if
root# dmesg
[ 1559.599235] virt_net_if: unregister rx handler for enp0s3
[ 1559.599271] vni0: device closed
[ 1559.613699] Module virt_net_if unloaded
[ 1559.613703] virt_net_if: proc file is deleted
```
